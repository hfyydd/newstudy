# 间隔复习产品文档

## 文档概述

本文档详细说明了闪词学习应用中的间隔复习（Spaced Repetition）功能的设计理念、科学依据、实现规则和算法逻辑。

---

## 1. 功能概述

间隔复习是一种基于记忆科学的学习方法，通过在不同时间间隔重复学习内容，帮助用户将短期记忆转化为长期记忆。本应用根据用户对词条的掌握程度，动态调整复习间隔，优化学习效率。

---

## 2. 科学依据

### 2.1 艾宾浩斯遗忘曲线（Ebbinghaus Forgetting Curve）

德国心理学家赫尔曼·艾宾浩斯（Hermann Ebbinghaus）在19世纪末通过实验发现：

- **遗忘速度先快后慢**：学习后1小时内遗忘速度最快，之后逐渐减慢
- **遗忘临界点**：在遗忘临界点前进行复习，可以显著提升记忆保持率
- **典型遗忘率**：
  - 1小时后：约44%被遗忘
  - 1天后：约67%被遗忘
  - 6天后：约75%被遗忘

### 2.2 间隔重复理论（Spaced Repetition）

间隔重复是一种经过科学研究验证的有效学习方法：

- **核心原理**：根据学习者对知识的掌握程度，动态调整复习间隔
- **基本原则**：
  - 掌握度越低，复习间隔越短（需要频繁强化）
  - 掌握度越高，复习间隔越长（已形成长期记忆）
- **效果**：有助于将短期记忆转化为长期记忆，提高学习效率

### 2.3 参考算法

本应用的间隔复习规则参考了以下经典算法：

- **SuperMemo算法**：基于遗忘曲线和记忆强度的自适应算法
- **Anki算法**：使用类似间隔重复原理的算法
- **SM-2算法**：经典的间隔重复算法，广泛应用于闪卡应用

---

## 3. 复习间隔规则

### 3.1 规则定义

根据词条的学习状态（由AI评估分数决定），系统会设置不同的复习间隔：

| 状态 | 分数范围 | 复习间隔 | 说明 | 科学依据 |
|------|---------|---------|------|---------|
| **未掌握** | 0-49分 | **4小时后** | 需要尽快重新学习 | 遗忘最快，需快速强化，防止完全遗忘 |
| **需改进** | 50-69分 | **3天后** | 有一定理解但需改进 | 有一定理解，给予消化时间，避免过度复习 |
| **需巩固** | 70-89分 | **1天后** | 基本理解正确 | 基本掌握，在遗忘临界点前巩固记忆 |
| **已掌握** | 90-100分 | **7天后** | 长期复习巩固 | 已形成长期记忆，延长间隔进行长期巩固 |

### 3.2 规则说明

#### 未掌握（NOT_MASTERED）- 4小时后
- **适用场景**：用户对词条的理解不充分，AI评估分数在0-49分
- **设计理由**：
  - 遗忘速度最快，需要快速强化
  - 防止完全遗忘，避免需要重新学习
  - 4小时间隔确保在遗忘临界点前进行复习

#### 需改进（NEEDS_IMPROVE）- 3天后
- **适用场景**：用户对词条有一定理解，但不够准确，AI评估分数在50-69分
- **设计理由**：
  - 有一定理解基础，给予消化时间
  - 避免过度复习导致疲劳
  - 3天间隔允许用户有时间思考和改进

#### 需巩固（NEEDS_REVIEW）- 1天后
- **适用场景**：用户对词条基本理解正确，AI评估分数在70-89分
- **设计理由**：
  - 基本掌握，在遗忘临界点前巩固
  - 1天间隔符合艾宾浩斯遗忘曲线的关键时间点
  - 及时复习可以显著提升记忆保持率
- **命名说明**：为避免与"今日需要复习"功能混淆，命名为"需巩固"

#### 已掌握（MASTERED）- 7天后
- **适用场景**：用户对词条理解准确深入，AI评估分数在90-100分
- **设计理由**：
  - 已形成长期记忆，延长间隔进行巩固
  - 7天间隔适合长期记忆的维护
  - 避免过度复习，提高学习效率

---

## 4. 实现逻辑

### 4.1 数据库设计

#### 闪词卡片表（flash_cards）

关键字段：
- `status`：词条状态（NOT_STARTED, NEEDS_REVIEW（需巩固）, NEEDS_IMPROVE, NOT_MASTERED, MASTERED）
- `last_reviewed_at`：最后复习时间（TIMESTAMP）
- `review_count`：复习次数（INTEGER）
- `mastered_at`：掌握时间（TIMESTAMP，仅当状态为MASTERED时）

#### 学习记录表（learning_records）

关键字段：
- `card_id`：闪词卡片ID
- `score`：AI评估分数（0-100）
- `status`：本次评估的状态
- `attempted_at`：学习时间（TIMESTAMP）

### 4.2 状态更新逻辑

#### 学习评估后更新

当用户完成一次学习评估后：

1. **保存学习记录**：记录本次学习的详细信息（分数、状态、反馈等）
2. **更新卡片状态**：根据AI评估分数确定新的状态
3. **更新复习时间**：设置 `last_reviewed_at = NOW()`
4. **更新掌握时间**：如果达到已掌握状态，设置 `mastered_at = NOW()`

#### 手动更新状态

当用户手动更新卡片状态时：

- 如果状态为 `MASTERED`：更新 `last_reviewed_at` 和 `mastered_at`
- 如果状态为 `NEEDS_REVIEW`（需巩固）、`NEEDS_IMPROVE`、`NOT_MASTERED`：更新 `last_reviewed_at`
- 如果状态为 `NOT_STARTED`：不更新 `last_reviewed_at`（因为不是学习行为）

### 4.3 今日复习判断逻辑

系统通过以下SQL逻辑判断词条是否需要今日复习：

```sql
-- 未掌握：4小时后需要复习
(fc.status = 'NOT_MASTERED' AND (
    fc.last_reviewed_at IS NULL OR 
    fc.last_reviewed_at + INTERVAL '4 hours' <= NOW()
))

-- 需改进：3天后需要复习
(fc.status = 'NEEDS_IMPROVE' AND (
    fc.last_reviewed_at IS NULL OR 
    fc.last_reviewed_at + INTERVAL '3 days' <= NOW()
))

-- 需巩固：1天后需要复习
(fc.status = 'NEEDS_REVIEW' AND (
    fc.last_reviewed_at IS NULL OR 
    fc.last_reviewed_at + INTERVAL '1 day' <= NOW()
))

-- 已掌握：7天后需要复习
(fc.status = 'MASTERED' AND (
    fc.last_reviewed_at IS NULL OR 
    fc.last_reviewed_at + INTERVAL '7 days' <= NOW()
))
```

### 4.4 优先级排序

在今日复习列表中，词条按以下优先级排序：

1. **状态优先级**：未掌握 > 需改进 > 需巩固 > 已掌握
2. **时间优先级**：`last_reviewed_at` 越早的越优先
3. **ID优先级**：相同条件下，ID小的优先

---

## 5. API接口

### 5.1 获取今日复习词条列表

**接口**：`GET /study-center/today-review`

**功能**：返回所有需要今日复习的词条列表

**查询逻辑**：
- 根据词条状态和 `last_reviewed_at` 时间判断是否需要复习
- 使用上述SQL逻辑筛选符合条件的词条
- 按优先级排序返回

**参数**：
- `skip`：跳过数量（默认0）
- `limit`：返回数量（默认100，最大100）

### 5.2 获取学习中心统计数据

**接口**：`GET /study-center/statistics`

**功能**：返回学习中心的统计数据

**返回数据**：
- `today_review_count`：今日需要复习的数量
- `mastered_count`：已掌握数量
- `needs_review_count`：需巩固数量（70-89分）
- `needs_improve_count`：需改进数量
- `not_mastered_count`：未掌握数量
- `total_cards_count`：全部词条数量

**计算逻辑**：
- `today_review_count` 使用与今日复习列表相同的判断逻辑
- 其他统计数据按状态直接统计

---

## 6. 用户体验

### 6.1 学习流程

1. **用户学习词条**：在费曼学习页面选择角色并解释词条
2. **AI评估**：系统评估用户解释，给出分数和反馈
3. **状态更新**：根据分数更新词条状态和复习时间
4. **复习提醒**：系统根据复习间隔自动提醒用户复习

### 6.2 复习提醒

- **今日复习卡片**：在首页和学习中心主页显示今日需要复习的词条数量
- **优先级显示**：未掌握的词条优先显示，确保用户优先复习薄弱内容
- **时间显示**：显示词条的最后学习时间，帮助用户了解学习历史

### 6.3 学习统计

- **状态分布**：显示各状态词条的数量分布
- **学习进度**：显示已掌握词条占比
- **复习计划**：显示今日需要复习的词条数量

---

## 7. 优化建议

### 7.1 个性化调整

未来可以考虑根据用户的学习表现动态调整复习间隔：

- **学习速度快**：可以适当延长复习间隔
- **学习速度慢**：可以适当缩短复习间隔
- **遗忘率高**：可以增加复习频率

### 7.2 算法优化

可以考虑实现更复杂的间隔重复算法：

- **SM-2算法**：根据用户表现动态调整间隔
- **SuperMemo算法**：基于记忆强度和遗忘曲线
- **自适应算法**：根据用户历史数据学习最优间隔

### 7.3 数据分析

可以收集以下数据用于优化算法：

- 用户在不同间隔下的记忆保持率
- 不同状态词条的遗忘速度
- 用户的学习习惯和偏好

---

## 8. 技术实现

### 8.1 后端实现

**文件位置**：`backend/server.py`

**关键函数**：
- `get_today_review_cards()`：获取今日复习词条列表
- `get_study_center_statistics()`：获取学习中心统计数据
- `evaluate_user_explanation()`：评估用户解释并更新状态

**数据库查询**：
- 使用PostgreSQL的 `INTERVAL` 功能计算复习时间
- 使用 `NOW()` 函数获取当前时间
- 使用 `NULLS FIRST` 处理未学习过的词条

### 8.2 前端实现

**文件位置**：`newstudyapp/lib/pages/study_center/`

**关键组件**：
- `StudyCenterController`：学习中心控制器
- `StudyCenterPage`：学习中心页面
- `StudyCenterState`：学习中心状态管理

**功能**：
- 显示今日复习词条列表
- 显示学习统计数据
- 支持下拉刷新
- 支持词条详情查看

---

## 9. 测试用例

### 9.1 基本功能测试

1. **学习后更新状态**：
   - 用户学习词条，AI评估分数为45分
   - 验证：状态更新为 `NOT_MASTERED`，`last_reviewed_at` 更新为当前时间

2. **复习间隔判断**：
   - 词条状态为 `NOT_MASTERED`，`last_reviewed_at` 为4小时前
   - 验证：该词条出现在今日复习列表中

3. **状态优先级**：
   - 有多个不同状态的词条需要复习
   - 验证：未掌握的词条排在前面

### 9.2 边界情况测试

1. **未学习过的词条**：
   - `last_reviewed_at` 为 `NULL`
   - 验证：出现在今日复习列表中

2. **刚学习的词条**：
   - `last_reviewed_at` 为当前时间
   - 验证：不立即出现在今日复习列表中（除非状态为未掌握且已过4小时）

3. **已掌握词条**：
   - 状态为 `MASTERED`，`last_reviewed_at` 为6天前
   - 验证：不出现在今日复习列表中（需要7天后）

---

## 10. 常见问题

### 10.1 为什么未掌握的词条间隔最短？

未掌握的词条遗忘速度最快，需要在遗忘临界点前进行复习。4小时的间隔可以确保在用户还没有完全遗忘时进行强化学习。

### 10.2 为什么已掌握的词条还要复习？

即使词条已达到已掌握状态，长期不复习仍可能遗忘。7天的间隔可以帮助用户巩固长期记忆，防止遗忘。

### 10.3 复习间隔可以调整吗？

当前版本使用固定的复习间隔规则。未来版本可能会支持用户自定义间隔或根据学习表现自动调整。

### 10.4 如果用户连续多次学习同一个词条会怎样？

每次学习都会更新 `last_reviewed_at` 时间，复习间隔会从最新一次学习时间开始计算。

---

## 11. 更新日志

### 版本 1.0.0（2025-01-XX）

- 初始版本
- 实现基本的间隔复习功能
- 支持4种状态的复习间隔规则
- 实现今日复习列表和统计功能

---

## 12. 参考资料

1. **艾宾浩斯遗忘曲线**：
   - Ebbinghaus, H. (1885). Memory: A contribution to experimental psychology.

2. **间隔重复理论**：
   - Cepeda, N. J., et al. (2006). Distributed practice in verbal recall tasks: A review and quantitative synthesis.

3. **SuperMemo算法**：
   - Wozniak, P. (1990). Optimization of learning.

4. **Anki算法**：
   - Anki Documentation: https://docs.ankiweb.net/

---

**文档版本**：1.0.0  
**最后更新**：2025年1月  
**维护者**：开发团队

