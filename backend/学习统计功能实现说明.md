# 学习统计功能实现说明

## 📊 功能概述

本次实现了完整的学习统计功能，包括：
1. ✅ 学习历史记录表（learning_history）
2. ✅ 自动记录学习历史
3. ✅ 连续学习天数计算
4. ✅ 累计学习时长统计
5. ✅ 数据库迁移脚本

## 🗄️ 数据库结构

### 新增表：learning_history（学习历史表）

```sql
CREATE TABLE learning_history (
    id TEXT PRIMARY KEY,
    card_id TEXT NOT NULL,
    note_id TEXT NOT NULL,
    status TEXT NOT NULL,
    duration_seconds INTEGER DEFAULT 0,
    studied_at TEXT NOT NULL,
    FOREIGN KEY (card_id) REFERENCES flash_cards(id) ON DELETE CASCADE,
    FOREIGN KEY (note_id) REFERENCES notes(id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX idx_learning_history_card_id ON learning_history(card_id);
CREATE INDEX idx_learning_history_studied_at ON learning_history(studied_at);
```

**字段说明**：
- `id`: 主键，UUID格式
- `card_id`: 闪词卡片ID（外键）
- `note_id`: 笔记ID（外键）
- `status`: 学习后的状态（notStarted/needsReview/needsImprove/mastered）
- `duration_seconds`: 学习时长（秒），默认60秒
- `studied_at`: 学习时间（ISO 8601格式）

## 🔧 实现的功能

### 1. 自动记录学习历史

当调用 `update_flash_card_status()` 更新卡片状态时，系统会自动记录一条学习历史记录。

**位置**：`backend/database.py` - `update_flash_card_status()` 方法

```python
# 记录学习历史（默认每次学习耗时60秒）
history_id = str(uuid4())
cursor.execute("""
    INSERT INTO learning_history 
    (id, card_id, note_id, status, duration_seconds, studied_at)
    VALUES (?, ?, ?, ?, ?, ?)
""", (history_id, card_id, note_id, status, 60, now_str))
```

### 2. 学习统计计算

**位置**：`backend/database.py` - `get_learning_statistics()` 方法

返回的统计信息包括：
- `mastered`: 已掌握词条数（status='mastered'的卡片数）
- `totalTerms`: 累计学习词条数（所有闪词卡片总数）
- `consecutiveDays`: 连续学习天数（基于学习历史记录计算）
- `totalMinutes`: 累计学习时长（分钟，基于所有学习历史记录汇总）

### 3. 连续学习天数计算逻辑

**位置**：`backend/database.py` - `_calculate_consecutive_days()` 方法

**计算规则**：
1. 从最近的学习日期开始，往前统计连续天数
2. 如果最后一次学习不是今天或昨天，则连续天数为0
3. 如果某一天没有学习记录，则中断连续计算

**示例**：
- 如果最近3天都有学习记录：连续天数 = 3
- 如果最近学习是2天前：连续天数 = 0（中断）
- 如果今天有学习，昨天没有：连续天数 = 1

### 4. 累计学习时长统计

从 `learning_history` 表中汇总所有记录的 `duration_seconds` 字段，转换为分钟返回。

## 📝 API 接口

### GET /statistics

获取学习统计信息

**响应格式**：
```json
{
    "mastered": 16,
    "totalTerms": 126,
    "consecutiveDays": 1,
    "totalMinutes": 5
}
```

**字段说明**：
- `mastered`: 已掌握的词条数量
- `totalTerms`: 累计学习的词条总数
- `consecutiveDays`: 连续学习天数
- `totalMinutes`: 累计学习时长（分钟）

## 🔄 数据库迁移

### 迁移脚本

运行迁移脚本为现有数据库添加学习历史表：

```bash
cd backend
python migrate_add_learning_history.py
```

**脚本功能**：
- 检查并创建 `learning_history` 表（如果不存在）
- 创建必要的索引
- 显示数据库统计信息

**输出示例**：
```
🔄 开始迁移数据库: notes.db
📝 创建 learning_history 表...
✅ learning_history 表创建成功
📝 创建索引 idx_learning_history_card_id...
✅ 索引创建成功
📝 创建索引 idx_learning_history_studied_at...
✅ 索引创建成功

📊 learning_history 表结构：
  - id (TEXT)
  - card_id (TEXT)
  - note_id (TEXT)
  - status (TEXT)
  - duration_seconds (INTEGER)
  - studied_at (TEXT)

📈 数据库统计：
  - 笔记数量: 6
  - 闪词卡片数量: 126
  - 学习历史记录数量: 0

✅ 数据库迁移完成！
```

## 🧪 测试

### 测试脚本

运行测试脚本验证功能：

```bash
cd backend
python test_statistics.py
```

**测试内容**：
1. 获取当前统计信息
2. 测试学习历史记录功能
3. 更新卡片状态（自动记录学习历史）
4. 验证统计信息变化
5. 检查学习历史记录
6. 测试连续天数计算逻辑

**测试输出示例**：
```
============================================================
📊 测试学习统计功能
============================================================

1️⃣  获取当前统计信息：
   ✅ 已掌握词条: 16
   📚 累计学习词条: 126
   🔥 连续学习天数: 0
   ⏱️  累计学习时长: 0 分钟

2️⃣  测试学习历史记录功能：
   📝 测试卡片: StateGraph (note_id: ...)

3️⃣  更新卡片状态（自动记录学习历史）：
   ✅ 卡片状态更新成功

4️⃣  更新后的统计信息：
   ✅ 已掌握词条: 16
   📚 累计学习词条: 126
   🔥 连续学习天数: 1
   ⏱️  累计学习时长: 1 分钟

5️⃣  验证学习历史记录：
   📊 学习历史记录数: 1
   📝 最近 1 条学习记录：
      - StateGraph: needsReview (60秒) - 2026-01-12 16:38:08

6️⃣  统计变化对比：
   ✅ 学习时长增加: 0分钟 → 1分钟
   ✅ 连续学习天数: 1天

✅ 统计功能测试完成！
```

## 📋 使用说明

### 对于现有数据库

1. **运行迁移脚本**（仅首次需要）：
   ```bash
   cd backend
   python migrate_add_learning_history.py
   ```

2. **重启后端服务**（如果正在运行）：
   ```bash
   # 停止现有服务
   pkill -f "python.*server.py"
   
   # 重新启动服务
   python server.py
   ```

3. **测试API接口**：
   ```bash
   curl http://localhost:8000/statistics
   ```

### 对于新数据库

新数据库会在首次运行时自动创建 `learning_history` 表（通过 `Database._init_db()` 方法）。

## 🎯 功能特点

1. **自动记录**：更新卡片状态时自动记录学习历史，无需额外调用
2. **精确统计**：基于真实的学习历史数据计算，而非估算
3. **连续天数**：智能计算连续学习天数，中断后自动重置
4. **累计时长**：记录每次学习的时长，汇总后显示总时长
5. **向后兼容**：迁移脚本支持现有数据库，不影响现有数据

## 🔮 未来扩展建议

1. **精确时长记录**：前端可以记录实际学习时长，传递给后端
2. **学习趋势分析**：基于历史数据生成学习趋势图表
3. **学习报告**：生成周报、月报等学习报告
4. **学习目标**：设置每日学习目标，统计完成情况
5. **学习提醒**：基于连续天数提供学习提醒功能

## 📝 注意事项

1. **默认学习时长**：目前每次学习默认记录60秒，可以后续优化为实际学习时长
2. **时区处理**：日期计算基于服务器时区，建议统一使用UTC
3. **数据清理**：学习历史记录会随着卡片删除而级联删除
4. **性能考虑**：大量历史记录时，连续天数计算可能需要优化

## ✅ 完成状态

- [x] 创建学习历史表结构
- [x] 实现自动记录学习历史
- [x] 实现连续学习天数计算
- [x] 实现累计学习时长统计
- [x] 创建数据库迁移脚本
- [x] 创建测试脚本
- [x] 更新API接口（已有，无需修改）
- [x] 功能测试通过

---

**最后更新**：2026-01-12
