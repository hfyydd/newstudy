# 后端服务运行说明

## 快速开始

### 推荐方式：使用 uv 运行

```bash
cd backend
uv run python server.py
```

服务启动后会监听 `http://0.0.0.0:8000`

## 运行方式详解

### 方法 1: 使用 uv 运行（推荐）

项目使用 `uv` 作为依赖管理工具，这是最简单可靠的方式：

**基本运行：**
```bash
cd backend
uv run python server.py
```

**使用 uvicorn 命令（支持更多配置）：**
```bash
cd backend
uv run uvicorn server:app --host 0.0.0.0 --port 8000
```

**开发模式（代码修改后自动重载）：**
```bash
cd backend
uv run uvicorn server:app --host 0.0.0.0 --port 8000 --reload
```

### 方法 2: 使用虚拟环境运行

如果已经激活虚拟环境（`.venv`）：

```bash
cd backend
source .venv/bin/activate  # Linux/Mac
# 或
.venv\Scripts\activate     # Windows

python server.py
```

### 方法 3: 直接运行（需要已安装所有依赖）

```bash
cd backend
python3 server.py
```

## 服务配置

### 默认配置

- **主机**: `0.0.0.0`（监听所有网络接口）
- **端口**: `8000`
- **API 文档**: `http://localhost:8000/docs`
- **替代文档**: `http://localhost:8000/redoc`

### 修改端口

如果 8000 端口被占用，可以：

1. **修改代码**: 编辑 `server.py` 第 410 行，将 `port=8000` 改为其他端口
2. **使用 uvicorn 命令**: `uv run uvicorn server:app --port 8080`

## 验证服务运行

### 方法 1: 访问 API 文档（最简单）

打开浏览器访问: `http://localhost:8000/docs`

你会看到 Swagger UI 界面，可以测试所有 API 接口。

### 方法 2: 使用 curl 测试

```bash
# 测试获取术语接口
curl http://localhost:8000/topics/terms?category=economics

# 查看 API 文档
curl http://localhost:8000/docs
```

### 方法 3: 查看日志

服务启动后，控制台会显示：
```
INFO:     Started server process [xxxxx]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
```

## 环境配置

### LLM API Key（可选）

如果使用 LLM 功能，需要配置 API Key。创建 `backend/.env` 文件：

```env
API_KEY=your_api_key_here
BASE_URL=https://api.moonshot.cn/v1
MODEL=kimi-k2-turbo-preview
```

**注意**: 即使没有配置 API Key，服务器也能正常启动，只是 LLM 相关功能不可用。

### 数据库

- 数据库文件会自动创建在 `backend/notes.db`
- 首次运行会自动创建表结构
- 无需额外配置

## 停止服务

按 `Ctrl+C` 停止服务。

如果服务在后台运行，可以使用：

```bash
# 查找占用 8000 端口的进程
lsof -ti:8000

# 停止进程（替换 PID 为实际进程ID）
kill -9 <PID>

# 或者一键停止
lsof -ti:8000 | xargs kill -9
```

## 常见问题

### 1. 端口被占用

```
Error: [Errno 48] Address already in use
```

**解决方法**:
- 停止占用端口的进程：`lsof -ti:8000 | xargs kill -9`
- 或者修改端口号

### 2. 模块未找到错误

```
ModuleNotFoundError: No module named 'fastapi'
```

**解决方法**:
- 使用 `uv run python server.py` 运行（推荐）
- 或者先安装依赖：`uv sync`

### 3. 数据库文件权限错误

**解决方法**:
- 确保 `backend` 目录有写入权限
- 检查磁盘空间是否充足

## 开发建议

### 开发模式

使用 `--reload` 参数，代码修改后自动重启：

```bash
uv run uvicorn server:app --host 0.0.0.0 --port 8000 --reload
```

### 查看日志

服务运行时的日志会直接输出到控制台，包括：
- 请求日志
- 错误信息
- 数据库操作（如果有配置）

### 调试

1. 使用 `http://localhost:8000/docs` 测试接口
2. 查看控制台输出的错误信息
3. 检查 `notes.db` 数据库文件是否存在且有数据
