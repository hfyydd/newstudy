# æ•°æ®åº“ç»“æ„è®¾è®¡æ–‡æ¡£

## ğŸ“Š æ•°æ®åº“æ¦‚è§ˆ

é¡¹ç›®ä½¿ç”¨ **SQLite** ä½œä¸ºæ•°æ®å­˜å‚¨ï¼Œæ•°æ®åº“æ–‡ä»¶ä½äº `backend/notes.db`ã€‚

### æ ¸å¿ƒå®ä½“å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    notes    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”‚ flash_cards  â”‚
â”‚   (ç¬”è®°)    â”‚         â”‚  (é—ªè¯å¡ç‰‡)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    1 : N
```

**å…³ç³»è¯´æ˜**ï¼š
- ä¸€ä¸ªç¬”è®°ï¼ˆnoteï¼‰å¯ä»¥åŒ…å«å¤šä¸ªé—ªè¯å¡ç‰‡ï¼ˆflash_cardï¼‰
- ä¸€ä¸ªé—ªè¯å¡ç‰‡åªå±äºä¸€ä¸ªç¬”è®°
- åˆ é™¤ç¬”è®°æ—¶ï¼Œå…³è”çš„é—ªè¯å¡ç‰‡ä¼šè‡ªåŠ¨åˆ é™¤ï¼ˆçº§è”åˆ é™¤ï¼‰

---

## ğŸ“‹ æ•°æ®è¡¨ç»“æ„

### 1. `notes` è¡¨ - ç¬”è®°è¡¨

å­˜å‚¨ç”¨æˆ·åˆ›å»ºçš„ç¬”è®°ä¿¡æ¯ã€‚

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|------|------|------|
| `id` | TEXT | PRIMARY KEY | ç¬”è®°å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆUUIDæ ¼å¼ï¼‰ |
| `title` | TEXT | NULL | ç¬”è®°æ ‡é¢˜ï¼ˆå¯é€‰ï¼Œå¯ä¸ºç©ºï¼‰ |
| `content` | TEXT | NOT NULL | ç¬”è®°æ­£æ–‡å†…å®¹ |
| `created_at` | TEXT | NOT NULL | åˆ›å»ºæ—¶é—´ï¼ˆISO 8601æ ¼å¼ï¼Œå¦‚ï¼š`2024-01-01T12:00:00`ï¼‰ |
| `updated_at` | TEXT | NOT NULL | æœ€åæ›´æ–°æ—¶é—´ï¼ˆISO 8601æ ¼å¼ï¼‰ |

**ç¤ºä¾‹æ•°æ®**ï¼š
```sql
id: "550e8400-e29b-41d4-a716-446655440000"
title: "æœºå™¨å­¦ä¹ åŸºç¡€"
content: "æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªåˆ†æ”¯..."
created_at: "2024-01-01T10:00:00"
updated_at: "2024-01-01T10:00:00"
```

---

### 2. `flash_cards` è¡¨ - é—ªè¯å¡ç‰‡è¡¨

å­˜å‚¨ä»ç¬”è®°ä¸­æå–çš„è¯æ¡åŠå…¶å­¦ä¹ çŠ¶æ€ã€‚

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|------|------|------|
| `id` | TEXT | PRIMARY KEY | å¡ç‰‡å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆUUIDæ ¼å¼ï¼‰ |
| `note_id` | TEXT | NOT NULL, FOREIGN KEY | æ‰€å±ç¬”è®°IDï¼ˆå¤–é”®ï¼Œå…³è” `notes.id`ï¼‰ |
| `term` | TEXT | NOT NULL | è¯æ¡å†…å®¹ï¼ˆå¦‚ï¼š"æ¢¯åº¦ä¸‹é™"ã€"ç¥ç»ç½‘ç»œ"ï¼‰ |
| `status` | TEXT | NOT NULL, DEFAULT 'notStarted' | å­¦ä¹ çŠ¶æ€ï¼ˆè§ä¸‹æ–¹çŠ¶æ€è¯´æ˜ï¼‰ |
| `created_at` | TEXT | NOT NULL | å¡ç‰‡åˆ›å»ºæ—¶é—´ï¼ˆISO 8601æ ¼å¼ï¼‰ |
| `last_reviewed_at` | TEXT | NULL | æœ€åå¤ä¹ æ—¶é—´ï¼ˆISO 8601æ ¼å¼ï¼Œå¯ä¸ºç©ºï¼‰ |

**çº¦æŸ**ï¼š
- `UNIQUE(note_id, term)`ï¼šåŒä¸€ç¬”è®°ä¸­ï¼Œè¯æ¡ä¸èƒ½é‡å¤
- `FOREIGN KEY (note_id) REFERENCES notes(id) ON DELETE CASCADE`ï¼šçº§è”åˆ é™¤

**å­¦ä¹ çŠ¶æ€ï¼ˆstatusï¼‰æšä¸¾å€¼**ï¼š
- `notStarted`ï¼šæœªå¼€å§‹å­¦ä¹ ï¼ˆé»˜è®¤çŠ¶æ€ï¼‰
- `needsReview`ï¼šéœ€è¦å¤ä¹ ï¼ˆå›°éš¾è¯æ¡ï¼‰
- `needsImprove`ï¼šéœ€è¦æ”¹è¿›ï¼ˆä¸­ç­‰éš¾åº¦ï¼‰
- `mastered`ï¼šå·²æŒæ¡

**ç¤ºä¾‹æ•°æ®**ï¼š
```sql
id: "660e8400-e29b-41d4-a716-446655440001"
note_id: "550e8400-e29b-41d4-a716-446655440000"
term: "æ¢¯åº¦ä¸‹é™"
status: "mastered"
created_at: "2024-01-01T10:05:00"
last_reviewed_at: "2024-01-02T15:30:00"
```

---

## ğŸ” ç´¢å¼•è®¾è®¡

ä¸ºäº†æé«˜æŸ¥è¯¢æ€§èƒ½ï¼Œåˆ›å»ºäº†ä»¥ä¸‹ç´¢å¼•ï¼š

| ç´¢å¼•å | è¡¨ | å­—æ®µ | è¯´æ˜ |
|--------|------|------|------|
| `idx_flash_cards_note_id` | `flash_cards` | `note_id` | åŠ é€ŸæŒ‰ç¬”è®°IDæŸ¥è¯¢é—ªè¯å¡ç‰‡ |
| `idx_flash_cards_status` | `flash_cards` | `status` | åŠ é€ŸæŒ‰å­¦ä¹ çŠ¶æ€ç­›é€‰ï¼ˆå¦‚ï¼šæŸ¥è¯¢éœ€è¦å¤ä¹ çš„è¯æ¡ï¼‰ |

---

## ğŸ—ï¸ Python æ•°æ®æ¨¡å‹ç±»

### `Note` ç±»

```python
class Note:
    def __init__(
        self,
        note_id: str,           # ç¬”è®°ID
        title: Optional[str],    # ç¬”è®°æ ‡é¢˜ï¼ˆå¯ä¸ºNoneï¼‰
        content: str,            # ç¬”è®°å†…å®¹
        created_at: datetime,    # åˆ›å»ºæ—¶é—´
        updated_at: datetime,    # æ›´æ–°æ—¶é—´
    ):
        self.id = note_id
        self.title = title
        self.content = content
        self.created_at = created_at
        self.updated_at = updated_at
```

### `FlashCard` ç±»

```python
class FlashCard:
    def __init__(
        self,
        card_id: str,                    # å¡ç‰‡ID
        note_id: str,                    # æ‰€å±ç¬”è®°ID
        term: str,                        # è¯æ¡å†…å®¹
        status: str = "notStarted",       # å­¦ä¹ çŠ¶æ€
        created_at: Optional[datetime] = None,      # åˆ›å»ºæ—¶é—´
        last_reviewed_at: Optional[datetime] = None, # æœ€åå¤ä¹ æ—¶é—´
    ):
        self.id = card_id
        self.note_id = note_id
        self.term = term
        self.status = status
        self.created_at = created_at or datetime.now()
        self.last_reviewed_at = last_reviewed_at
```

---

## ğŸ”„ æ•°æ®æµè½¬æµç¨‹

### 1. åˆ›å»ºç¬”è®°æµç¨‹

```
ç”¨æˆ·è¾“å…¥ç¬”è®°å†…å®¹
    â†“
POST /notes
    â†“
db.create_note(title, content)
    â†“
INSERT INTO notes (id, title, content, created_at, updated_at)
    â†“
è¿”å› Note å¯¹è±¡
```

### 2. ç”Ÿæˆé—ªè¯å¡ç‰‡æµç¨‹

```
ç”¨æˆ·é€‰æ‹©ç¬”è®°
    â†“
POST /notes/{note_id}/flash-cards/generate
    â†“
æå–ç¬”è®°ä¸­çš„è¯æ¡ï¼ˆLLM æˆ–è§„åˆ™æå–ï¼‰
    â†“
db.create_flash_cards(note_id, terms)
    â†“
å¯¹æ¯ä¸ªè¯æ¡ï¼š
  - æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼ˆUNIQUEçº¦æŸï¼‰
  - å¦‚æœä¸å­˜åœ¨ï¼ŒINSERT INTO flash_cards
  - å¦‚æœå·²å­˜åœ¨ï¼Œè·³è¿‡ï¼ˆä¿ç•™åŸæœ‰å­¦ä¹ çŠ¶æ€ï¼‰
    â†“
æ›´æ–° notes.updated_at
    â†“
è¿”å›ç”Ÿæˆçš„å¡ç‰‡åˆ—è¡¨
```

### 3. æ›´æ–°å­¦ä¹ çŠ¶æ€æµç¨‹

```
ç”¨æˆ·åœ¨é—ªå¡ç•Œé¢æ ‡è®°"å·²æŒæ¡"
    â†“
PUT /notes/{note_id}/flash-cards/status
    â†“
db.update_flash_card_status(note_id, term, "mastered")
    â†“
UPDATE flash_cards 
SET status = 'mastered', last_reviewed_at = NOW()
WHERE note_id = ? AND term = ?
    â†“
è¿”å›æˆåŠŸ/å¤±è´¥
```

### 4. æŸ¥è¯¢å¤ä¹ å¡ç‰‡æµç¨‹

```
ç”¨æˆ·è¿›å…¥å­¦ä¹ ä¸­å¿ƒ
    â†“
GET /review/cards
    â†“
db.get_review_flash_cards()
    â†“
SELECT * FROM flash_cards 
WHERE status IN ('needsReview', 'needsImprove')
ORDER BY status, created_at
    â†“
å…³è”æŸ¥è¯¢ notes è¡¨è·å–ç¬”è®°æ ‡é¢˜
    â†“
è¿”å› ReviewFlashCardResponse åˆ—è¡¨
```

---

## ğŸ“Š ç»Ÿè®¡æŸ¥è¯¢

### ç¬”è®°å­¦ä¹ è¿›åº¦ç»Ÿè®¡

```python
db.get_flash_card_progress(note_id)
```

è¿”å›ï¼š
```python
{
    "total": 30,           # æ€»è¯æ¡æ•°
    "mastered": 10,        # å·²æŒæ¡æ•°é‡
    "needsReview": 5,      # å¾…å¤ä¹ æ•°é‡
    "needsImprove": 8,     # éœ€æ”¹è¿›æ•°é‡
    "notStarted": 7        # æœªå­¦ä¹ æ•°é‡
}
```

### å…¨å±€å­¦ä¹ ç»Ÿè®¡

```python
db.get_learning_statistics()
```

è¿”å›ï¼š
```python
{
    "mastered": 150,       # å…¨å±€å·²æŒæ¡è¯æ¡æ•°
    "totalTerms": 500,      # å…¨å±€æ€»è¯æ¡æ•°
    "consecutiveDays": 0,   # è¿ç»­å­¦ä¹ å¤©æ•°ï¼ˆæš‚æœªå®ç°ï¼‰
    "totalMinutes": 0      # ç´¯è®¡å­¦ä¹ æ—¶é•¿ï¼ˆæš‚æœªå®ç°ï¼‰
}
```

### ä»Šæ—¥å¤ä¹ ç»Ÿè®¡

```python
db.get_today_review_statistics()
```

è¿”å›ï¼š
```python
{
    "total": 25,           # éœ€è¦å¤ä¹ çš„æ€»æ•°
    "needsReview": 15,     # å›°éš¾è¯æ¡æ•°
    "needsImprove": 10     # éœ€æ”¹è¿›è¯æ¡æ•°
}
```

---

## ğŸ”Œ API å“åº”æ¨¡å‹æ˜ å°„

### ç¬”è®°ç›¸å…³

| API ç«¯ç‚¹ | å“åº”æ¨¡å‹ | æ•°æ®åº“æŸ¥è¯¢ |
|---------|---------|-----------|
| `GET /notes` | `NotesListResponse` | `db.list_notes()` + `db.get_flash_card_progress()` |
| `GET /notes/{id}` | `NoteResponse` | `db.get_note()` + `db.get_flash_card_progress()` |
| `POST /notes` | `NoteResponse` | `db.create_note()` |

### é—ªè¯å¡ç‰‡ç›¸å…³

| API ç«¯ç‚¹ | å“åº”æ¨¡å‹ | æ•°æ®åº“æŸ¥è¯¢ |
|---------|---------|-----------|
| `POST /notes/{id}/flash-cards/generate` | `FlashCardGenerateResponse` | `db.create_flash_cards()` |
| `GET /notes/{id}/flash-cards` | `FlashCardListResponse` | `db.get_flash_cards()` |
| `GET /notes/{id}/flash-cards/progress` | `FlashCardProgressResponse` | `db.get_flash_card_progress()` |
| `PUT /notes/{id}/flash-cards/status` | `FlashCardStatusUpdateResponse` | `db.update_flash_card_status()` |

### å¤ä¹ ç›¸å…³

| API ç«¯ç‚¹ | å“åº”æ¨¡å‹ | æ•°æ®åº“æŸ¥è¯¢ |
|---------|---------|-----------|
| `GET /review/cards` | `ReviewFlashCardsResponse` | `db.get_review_flash_cards()` + `db.get_note()` |
| `GET /review/today` | `TodayReviewStatisticsResponse` | `db.get_today_review_statistics()` |
| `GET /review/statistics` | `LearningStatisticsResponse` | `db.get_learning_statistics()` |

---

## ğŸ¯ è®¾è®¡è¦ç‚¹

### 1. è¯æ¡å»é‡æœºåˆ¶

- **UNIQUE(note_id, term)** çº¦æŸç¡®ä¿åŒä¸€ç¬”è®°ä¸­è¯æ¡ä¸é‡å¤
- ç”Ÿæˆé—ªè¯å¡ç‰‡æ—¶ï¼Œå¦‚æœè¯æ¡å·²å­˜åœ¨ï¼Œä¼šè·³è¿‡æ’å…¥ï¼Œ**ä¿ç•™åŸæœ‰çš„å­¦ä¹ çŠ¶æ€**
- è¿™æ ·å¯ä»¥é¿å…é‡å¤å­¦ä¹ å·²æŒæ¡çš„è¯æ¡

### 2. çº§è”åˆ é™¤

- åˆ é™¤ç¬”è®°æ—¶ï¼Œå…³è”çš„é—ªè¯å¡ç‰‡ä¼šè‡ªåŠ¨åˆ é™¤
- é€šè¿‡ `ON DELETE CASCADE` å¤–é”®çº¦æŸå®ç°
- ç¡®ä¿æ•°æ®ä¸€è‡´æ€§

### 3. æ—¶é—´æˆ³å­˜å‚¨

- æ‰€æœ‰æ—¶é—´å­—æ®µä½¿ç”¨ **ISO 8601 æ ¼å¼å­—ç¬¦ä¸²**å­˜å‚¨ï¼ˆå¦‚ï¼š`2024-01-01T12:00:00`ï¼‰
- Python å±‚ä½¿ç”¨ `datetime` å¯¹è±¡å¤„ç†
- æ•°æ®åº“å±‚ä½¿ç”¨ `TEXT` ç±»å‹å­˜å‚¨

### 4. å­¦ä¹ çŠ¶æ€æµè½¬

```
notStarted â†’ needsReview â†’ needsImprove â†’ mastered
     â†“            â†“              â†“
   (å›°éš¾)      (ä¸­ç­‰)         (å·²æŒæ¡)
```

- ç”¨æˆ·å¯ä»¥é€šè¿‡"æ ‡è®°å·²æŒæ¡"ç›´æ¥è·³åˆ° `mastered` çŠ¶æ€
- çŠ¶æ€æ›´æ–°æ—¶ä¼šåŒæ—¶æ›´æ–° `last_reviewed_at` æ—¶é—´æˆ³

### 5. æ€§èƒ½ä¼˜åŒ–

- ä½¿ç”¨ç´¢å¼•åŠ é€Ÿå¸¸ç”¨æŸ¥è¯¢ï¼ˆæŒ‰ `note_id`ã€æŒ‰ `status`ï¼‰
- ç»Ÿè®¡æŸ¥è¯¢ä½¿ç”¨ `GROUP BY` å’Œèšåˆå‡½æ•°ï¼Œé¿å…å¤šæ¬¡æŸ¥è¯¢
- å¤ä¹ å¡ç‰‡æŸ¥è¯¢æŒ‰çŠ¶æ€ä¼˜å…ˆçº§æ’åºï¼ˆ`needsReview` ä¼˜å…ˆäº `needsImprove`ï¼‰

---

## ğŸ“ æ•°æ®ç¤ºä¾‹

### å®Œæ•´çš„ç¬”è®°å’Œé—ªè¯å¡ç‰‡ç¤ºä¾‹

**ç¬”è®°**ï¼š
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "title": "æœºå™¨å­¦ä¹ åŸºç¡€",
  "content": "æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªåˆ†æ”¯...",
  "created_at": "2024-01-01T10:00:00",
  "updated_at": "2024-01-01T10:00:00"
}
```

**å…³è”çš„é—ªè¯å¡ç‰‡**ï¼š
```json
[
  {
    "id": "660e8400-e29b-41d4-a716-446655440001",
    "note_id": "550e8400-e29b-41d4-a716-446655440000",
    "term": "æ¢¯åº¦ä¸‹é™",
    "status": "mastered",
    "created_at": "2024-01-01T10:05:00",
    "last_reviewed_at": "2024-01-02T15:30:00"
  },
  {
    "id": "660e8400-e29b-41d4-a716-446655440002",
    "note_id": "550e8400-e29b-41d4-a716-446655440000",
    "term": "ç¥ç»ç½‘ç»œ",
    "status": "needsReview",
    "created_at": "2024-01-01T10:05:00",
    "last_reviewed_at": "2024-01-01T11:00:00"
  }
]
```

---

## ğŸ”§ æ•°æ®åº“ç»´æŠ¤

### æŸ¥çœ‹æ•°æ®åº“ç»“æ„

```bash
sqlite3 backend/notes.db ".schema"
```

### æŸ¥çœ‹æ‰€æœ‰ç¬”è®°

```bash
sqlite3 backend/notes.db "SELECT * FROM notes;"
```

### æŸ¥çœ‹æ‰€æœ‰é—ªè¯å¡ç‰‡

```bash
sqlite3 backend/notes.db "SELECT * FROM flash_cards;"
```

### å¤‡ä»½æ•°æ®åº“

```bash
cp backend/notes.db backend/notes.db.backup
```

### é‡ç½®æ•°æ®åº“

```bash
rm backend/notes.db
# ä¸‹æ¬¡å¯åŠ¨æœåŠ¡æ—¶ä¼šè‡ªåŠ¨åˆ›å»ºæ–°æ•°æ®åº“
```

---

## ğŸš€ æœªæ¥æ‰©å±•å»ºè®®

1. **å­¦ä¹ å†å²è¡¨**ï¼šè®°å½•æ¯æ¬¡å­¦ä¹ çš„æ—¶é—´ã€æ—¶é•¿ã€ç»“æœï¼Œç”¨äºè®¡ç®—è¿ç»­å­¦ä¹ å¤©æ•°
2. **ç”¨æˆ·è¡¨**ï¼šæ”¯æŒå¤šç”¨æˆ·ï¼Œæ¯ä¸ªç”¨æˆ·æœ‰ç‹¬ç«‹çš„ç¬”è®°å’Œé—ªè¯å¡ç‰‡
3. **æ ‡ç­¾ç³»ç»Ÿ**ï¼šä¸ºç¬”è®°å’Œè¯æ¡æ·»åŠ æ ‡ç­¾ï¼Œæ”¯æŒåˆ†ç±»å’Œç­›é€‰
4. **å¤ä¹ è®¡åˆ’è¡¨**ï¼šåŸºäºé—å¿˜æ›²çº¿çš„æ™ºèƒ½å¤ä¹ æé†’
5. **å­¦ä¹ ç»Ÿè®¡è¡¨**ï¼šè®°å½•æ¯æ—¥å­¦ä¹ æ—¶é•¿ã€å­¦ä¹ è¯æ¡æ•°ç­‰ç»Ÿè®¡æ•°æ®

---

**æœ€åæ›´æ–°**ï¼š2024-01-01
