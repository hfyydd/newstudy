# 闪词学习产品文档

## 产品概述

费曼记忆法应用中的闪词学习功能，通过AI从笔记中提取核心词条，用户通过向AI解释词条含义来验证掌握程度，支持角色扮演式学习。

---

## 1. 从笔记生成闪词卡片列表

### 1.1 入口

用户在笔记详情页点击"生成闪词卡片"按钮。

### 1.2 生成流程

```
用户创建/查看笔记
    ↓
点击"生成闪词卡片"按钮
    ↓
调用AI提取核心词条（10-30个）
    ↓
保存词条列表到数据库
    ↓
显示学习进度概览
    ↓
进入费曼学习页面
```

### 1.3 AI提取规则

- **数量**：10-30个词条（根据内容长度）
- **类型**：核心概念、专业术语、关键知识点
- **去重**：自动去除重复词条
- **排序**：按重要性排序
- **长度**：2-12个字/字符

### 1.4 首次生成 vs 再次进入

#### 场景1：首次生成（无学习记录）

```
┌─────────────────────────────┐
│  笔记详情页                  │
├─────────────────────────────┤
│  📝 此笔记尚未生成闪词卡片    │
│                              │
│  [生成闪词卡片] 按钮         │
└─────────────────────────────┘
```

点击后：
- 调用AI提取词条
- 保存词条列表
- 为每个词条创建闪词卡片（status = 'notStarted'）
- 进入费曼学习页面

#### 场景2：再次进入（已有学习记录）

```
┌─────────────────────────────┐
│  笔记详情页                  │
├─────────────────────────────┤
│  📚 闪词学习进度              │
│  ├─ 总词条数：30个           │
│  ├─ 已掌握：12个 ✅          │
│  ├─ 需巩固：8个 ⏰           │
│  ├─ 需改进：5个 ⚠️           │
│  └─ 未学习：5个 📝           │
│                              │
│  [继续学习] ← 默认推荐       │
│  [重新生成闪词]               │
│  [查看学习记录]               │
└─────────────────────────────┘
```

操作说明：
- **继续学习**：进入费曼学习页面，优先显示需巩固和需改进的词条
- **重新生成闪词**：保留已掌握记录，重新提取词条列表
- **查看学习记录**：查看所有词条的学习历史

### 1.5 重新生成逻辑

当用户选择"重新生成闪词"时：

1. 显示确认对话框：
```
⚠️ 重新生成闪词卡片

将会：
✓ 保留所有已有词条的学习记录
✓ 添加新提取的词条到学习列表
✓ 新旧词条自动去重合并

[确认重新生成] [取消]
```

2. 用户确认后：
   - 调用AI重新提取词条
   - 对比新旧词条（按词条内容去重）：
     - **已存在的词条**：保持原有学习状态和记录
     - **新词条**：添加到列表（status = 'notStarted'）
   - 更新学习进度
   - 进入费曼学习页面

#### 示例说明

```
原有词条（30个）：
✅ 通货膨胀（已掌握）
✅ GDP（已掌握）
⏰ 利率（需巩固）
📝 货币供应量（未学习）
📝 经济增长（未学习）
...

AI重新提取（28个）：
通货膨胀、GDP、利率、通货紧缩、经济增长...
（不包含"货币供应量"）

重新生成后的列表（31个）：
✅ 通货膨胀（已掌握）← 保留学习状态
✅ GDP（已掌握）← 保留学习状态
⏰ 利率（需巩固）← 保留学习状态
📝 货币供应量（未学习）← 旧词条保留
📝 经济增长（未学习）← 保留
🆕 通货紧缩（未学习）← 新增
...

说明：所有旧词条保留，新词条追加，自动去重
```

---

## 2. 用户与闪词卡片的交互

### 2.1 学习页面布局

```
┌─────────────────────────────┐
│  ← 返回     笔记：经济学基础  │
├─────────────────────────────┤
│  进度：5/30                  │
│  [●●●●●○○○○○○○○○○] 17%      │
├─────────────────────────────┤
│                              │
│        卡片展示区域           │
│                              │
│     「通货膨胀」              │
│                              │
│   [选择解释角色]              │
│                              │
├─────────────────────────────┤
│  ← 上一张     下一张 →       │
└─────────────────────────────┘
```

### 2.2 角色选择功能

#### 角色列表

用户在开始解释前，选择解释角色：

```
┌─────────────────────────────┐
│  🎭 选择你的解释角色          │
├─────────────────────────────┤
│  👶 5岁孩子                  │
│     用最简单的语言解释        │
│                              │
│  👦 10岁小学生               │
│     用生活中的例子解释        │
│                              │
│  🎓 高中生                   │
│     用学科知识解释            │
│                              │
│  👨‍🎓 大学生                   │
│     用专业术语解释            │
│                              │
│  👨‍🏫 大学教授                 │
│     用深入的学术观点解释      │
│                              │
│  💼 行业专家                 │
│     结合实际应用解释          │
└─────────────────────────────┘
```

#### 角色对评估的影响

不同角色的评估标准不同：

| 角色 | 评估重点 | 期望表达方式 |
|------|---------|-------------|
| **5岁孩子** | 是否用最简单的语言、比喻 | "就像..." "好比..." |
| **10岁小学生** | 是否用生活例子说明 | 举例、故事化 |
| **高中生** | 是否覆盖基本概念 | 清晰的逻辑结构 |
| **大学生** | 是否使用准确术语、逻辑严谨 | 专业术语 + 解释 |
| **大学教授** | 是否深入本质、有批判性思考 | 学术观点、理论框架 |
| **行业专家** | 是否结合实际应用 | 实际案例、应用场景 |

### 2.3 学习交互流程

#### 完整流程图

```
选择词条
    ↓
查看词条名称（不显示定义）
    ↓
选择解释角色 ← 新增步骤
    ↓
输入解释（文字/语音）
    ↓
提交解释
    ↓
AI评估（根据角色评分）
    ↓
显示评估结果和反馈
    ↓
根据评分展示不同操作
```

#### 阶段1：选择角色

```
┌─────────────────────────────┐
│  词条：通货膨胀              │
├─────────────────────────────┤
│  🎭 选择你的解释角色          │
│                              │
│  [ 5岁孩子 ] [ 小学生 ]      │
│  [ 高中生 ] [ 大学生 ]        │
│  [ 教授 ] [ 专家 ]           │
│                              │
│  当前选择：5岁孩子 👶        │
│  提示：用最简单的语言解释，    │
│        可以打比方哦！         │
└─────────────────────────────┘
```

#### 阶段2：用户输入解释

```
┌─────────────────────────────┐
│  词条：通货膨胀              │
│  角色：5岁孩子 👶            │
├─────────────────────────────┤
│  💭 用5岁孩子能听懂的话解释   │
│                              │
│  ┌─────────────────────────┐│
│  │ [输入你的解释...]        ││
│  │                          ││
│  │                          ││
│  └─────────────────────────┘│
│                              │
│  [🎤 语音输入] [提交解释]    │
│                              │
│  提示：                      │
│  • 用简单的语言              │
│  • 可以举生活中的例子        │
│  • 可以用比喻                │
└─────────────────────────────┘
```

#### 阶段3：AI评估与反馈

根据评分显示不同结果：

##### 优秀（90-100分）

```
┌─────────────────────────────┐
│  🎉 优秀！你已经掌握了！      │
│  评分：95分                  │
├─────────────────────────────┤
│  ✅ 你的解释很棒：            │
│  • 用了简单易懂的比喻        │
│  • 准确抓住了核心概念        │
│  • 表达清晰流畅              │
│                              │
│  💡 补充知识：                │
│  通货膨胀还会影响...         │
├─────────────────────────────┤
│  [查看标准答案]              │
│  [标记为已掌握] [下一张]     │
└─────────────────────────────┘
```

操作：
- **查看标准答案**：对比学习
- **标记为已掌握**：进入已掌握列表，7天后长期复习
- **下一张**：继续学习下一个词条

##### 良好（70-89分）

```
┌─────────────────────────────┐
│  👍 良好！还有提升空间        │
│  评分：75分                  │
├─────────────────────────────┤
│  ✅ 你正确理解了：            │
│  • 物价上涨的基本概念        │
│                              │
│  💡 可以补充：                │
│  • 为什么会发生通货膨胀      │
│  • 对普通人的影响            │
│                              │
│  📝 改进建议：                │
│  试着用更简单的比喻，比如     │
│  可以说"钱变得不值钱了"      │
├─────────────────────────────┤
│  [查看标准答案] [重新解释]   │
│  [标记已掌握] [下一张]       │
└─────────────────────────────┘
```

操作：
- **查看标准答案**：学习完整定义
- **重新解释**：基于反馈优化解释
- **标记已掌握**：认为已经理解，进入下一张
- **下一张**：继续学习（该词条标记为"需巩固"）

##### 需改进（50-69分）

```
┌─────────────────────────────┐
│  ⚠️ 需要改进                 │
│  评分：60分                  │
├─────────────────────────────┤
│  ❌ 遗漏的关键点：            │
│  • 物价普遍上涨（不是单个）  │
│  • 货币购买力下降            │
│                              │
│  💭 思考提示：                │
│  1. 如果所有东西都变贵了，    │
│     同样的钱能买到的东西...? │
│  2. 为什么会出现这种情况？    │
│                              │
│  📖 简化解释：                │
│  想象你有10元钱...           │
├─────────────────────────────┤
│  [查看提示] [查看标准答案]   │
│  [重新解释] [跳过此卡片]     │
└─────────────────────────────┘
```

操作：
- **查看提示**：逐步引导思考
- **查看标准答案**：学习完整定义
- **重新解释**：基于提示重新组织
- **跳过此卡片**：标记为"需改进"，稍后复习

##### 未掌握（<50分）

```
┌─────────────────────────────┐
│  ❌ 未掌握，需要重新学习      │
│  评分：35分                  │
├─────────────────────────────┤
│  🔴 主要问题：                │
│  • 理解偏差：把通货膨胀理解   │
│    成了单个商品涨价          │
│  • 缺少核心概念              │
│                              │
│  📖 简化解释：                │
│  通货膨胀就像气球变大，里面   │
│  的钱还是那么多，但每个钱能   │
│  买到的东西变少了。           │
│                              │
│  💡 类比示例：                │
│  就像你的零花钱还是10元，但   │
│  以前能买2个冰淇淋，现在只能  │
│  买1个了。                   │
├─────────────────────────────┤
│  [查看简化解释] [查看类比]   │
│  [查看标准答案] [重新学习]   │
│  [跳过此卡片]                │
└─────────────────────────────┘
```

操作：
- **查看简化解释**：更简单的语言
- **查看类比示例**：通过类比理解
- **查看标准答案**：学习完整定义
- **重新学习**：回到笔记相关内容
- **跳过此卡片**：标记为"未掌握"（困难词库）

### 2.4 多轮对话机制

用户可以多次尝试解释同一词条：

```
第1次尝试：未掌握（35分）
    ↓
查看简化解释和类比
    ↓
第2次尝试：需改进（60分）
    ↓
查看提示
    ↓
第3次尝试：良好（75分）
    ↓
查看标准答案
    ↓
第4次尝试：优秀（90分）
    ↓
标记为已掌握
```

每次尝试都会记录：
- 尝试时间
- 用户解释内容
- AI评分和反馈
- 学习状态变化

### 2.5 卡片浏览模式

支持滑动浏览词条列表：

```
[卡片1] → [卡片2] → [卡片3] → ...
```

特性：
- 支持左右滑动切换卡片
- 显示当前进度（如：5/30）
- 已掌握的卡片可选择隐藏
- 可跳转到指定卡片

---

## 3. 闪词学习的入口设计

### 3.1 多入口架构

除了笔记详情页，系统提供多个入口让用户按不同场景进入闪词学习。

#### 完整入口架构图

```
应用架构
├─ 首页
│  ├─ 今日需要复习提醒（快捷入口）
│  ├─ 笔记列表
│  └─ 创建笔记/选择主题
│
├─ 复习中心（核心入口）
│  ├─ 今日复习（需巩固词条）
│  ├─ 困难词条（需改进、未掌握）
│  ├─ 已掌握词条
│  ├─ 全部词条
│  └─ 按笔记分类
│
├─ 笔记详情页（按笔记学习）
│  ├─ 闪词学习进度概览
│  ├─ 继续学习
│  └─ 重新生成闪词
│
├─ 学习统计
│  ├─ 学习概览
│  ├─ 学习趋势
│  └─ 已掌握词条列表
│
└─ 搜索（可选）
   └─ 搜索特定词条
```

### 3.2 入口1：首页快捷入口

#### 界面设计

```
┌─────────────────────────────┐
│  👋 欢迎回来！               │
├─────────────────────────────┤
│  🔥 今日需要复习：8个        │
│  [立即复习] ← 快捷入口       │
├─────────────────────────────┤
│  📚 我的笔记                 │
│  • 经济学基础                │
│    12/30已掌握 (40%)         │
│    [继续学习]                │
│                              │
│  • 机器学习笔记              │
│    5/15已掌握 (33%)          │
│    [继续学习]                │
├─────────────────────────────┤
│  [创建新笔记] [选择主题学习] │
└─────────────────────────────┘
```

#### 功能说明

- **今日需要复习提醒**：显示需要复习的词条数量（跨笔记统计）
- **笔记快捷入口**：显示最近学习的笔记和进度
- **立即复习按钮**：直接跳转到复习中心

### 3.3 入口2：复习中心（核心入口）

#### 页面结构

```
┌─────────────────────────────┐
│  📚 复习中心                 │
├─────────────────────────────┤
│  [今日复习] (8)              │
│  [困难词条] (3)              │
│  [已掌握词条] (25)           │
│  [全部词条] (50)             │
├─────────────────────────────┤
│  按笔记分类：                │
│  • 经济学基础 - 12个词条     │
│    需巩固：5个 已掌握：7个   │
│  • 机器学习笔记 - 8个词条    │
│    需巩固：3个 已掌握：5个   │
│  • 投资理论 - 5个词条        │
│    需巩固：0个 已掌握：5个   │
└─────────────────────────────┘
```

#### 今日复习页面

```
┌─────────────────────────────┐
│  ← 今日复习 (8个词条)        │
├─────────────────────────────┤
│  筛选：[全部] [需巩固]       │
│        [需改进] [未掌握]     │
├─────────────────────────────┤
│  📝 通货膨胀                 │
│     来源：经济学基础          │
│     状态：需巩固 ⏰           │
│     上次学习：2天前           │
│     最高分：75分              │
│     [开始学习]               │
│  ─────────────────────────── │
│  📝 梯度下降                 │
│     来源：机器学习笔记        │
│     状态：需改进 ⚠️           │
│     上次学习：1天前           │
│     尝试次数：3次             │
│     [开始学习]               │
└─────────────────────────────┘
```

#### 困难词条页面

```
┌─────────────────────────────┐
│  ← 困难词条 (3个)            │
├─────────────────────────────┤
│  这些词条需要重点关注 💪      │
├─────────────────────────────┤
│  📝 量子纠缠                 │
│     来源：物理学笔记          │
│     状态：未掌握 ❌           │
│     尝试次数：5次             │
│     最高分：45分              │
│     [重新学习]               │
│  ─────────────────────────── │
│  📝 黑洞理论                 │
│     来源：物理学笔记          │
│     状态：需改进 ⚠️           │
│     尝试次数：3次             │
│     最高分：65分              │
│     [继续学习]               │
└─────────────────────────────┘
```

#### 已掌握词条页面

```
┌─────────────────────────────┐
│  ← 已掌握词条 (25个)         │
├─────────────────────────────┤
│  恭喜！你已经掌握这些词条 🎉  │
├─────────────────────────────┤
│  ✅ 通货膨胀                 │
│     来源：经济学基础          │
│     掌握时间：2024-12-23      │
│     最高分：95分              │
│     [长期复习]               │
│  ─────────────────────────── │
│  ✅ GDP                      │
│     来源：经济学基础          │
│     掌握时间：2024-12-22      │
│     最高分：90分              │
│     [长期复习]               │
└─────────────────────────────┘
```

### 3.4 入口3：笔记详情页（已有）

按笔记维度查看和学习闪词。

```
┌─────────────────────────────┐
│  ← 笔记：经济学基础           │
├─────────────────────────────┤
│  📄 笔记内容...              │
├─────────────────────────────┤
│  📚 闪词学习进度              │
│  ├─ 总词条数：30个           │
│  ├─ 已掌握：12个 ✅          │
│  ├─ 需巩固：8个 ⏰           │
│  ├─ 需改进：5个 ⚠️           │
│  └─ 未学习：5个 📝           │
│                              │
│  [继续学习] [重新生成闪词]   │
│  [查看学习记录]              │
└─────────────────────────────┘
```

### 3.5 入口4：学习统计

查看学习成果和数据分析。

```
┌─────────────────────────────┐
│  我的 > 学习统计              │
├─────────────────────────────┤
│  📊 学习概览                 │
│  • 累计学习：50个词条        │
│  • 已掌握：25个 (50%)        │
│  • 学习天数：7天             │
│  • 累计时长：2小时15分       │
├─────────────────────────────┤
│  📈 学习趋势                 │
│  [折线图：每日学习词条数]    │
├─────────────────────────────┤
│  🏆 最近掌握                 │
│  • 通货膨胀 (2024-12-23)     │
│  • GDP (2024-12-22)          │
│  • 利率 (2024-12-21)         │
│                              │
│  [查看全部已掌握词条]        │
├─────────────────────────────┤
│  💪 困难词条                 │
│  • 量子纠缠 - 尝试5次        │
│  • 黑洞理论 - 尝试3次        │
│                              │
│  [查看困难词条]              │
└─────────────────────────────┘
```

### 3.6 入口5：搜索功能（可选）

快速查找特定词条。

```
┌─────────────────────────────┐
│  🔍 搜索词条                 │
├─────────────────────────────┤
│  [输入框：搜索词条...]        │
├─────────────────────────────┤
│  搜索结果：                  │
│                              │
│  通货膨胀                    │
│  • 经济学基础 - 已掌握 ✅    │
│    最后学习：2024-12-23       │
│                              │
│  • 投资理论 - 需巩固 ⏰      │
│    最后学习：2024-12-20       │
│                              │
│  通货紧缩                    │
│  • 经济学基础 - 未学习 📝    │
└─────────────────────────────┘
```

### 3.7 底部导航栏设计

```
┌─────────────────────────────┐
│                              │
│        主要内容区域           │
│                              │
├─────────────────────────────┤
│ [首页] [复习] [笔记] [我的]  │
│  🏠    📚    📝    👤       │
└─────────────────────────────┘
```

导航说明：
- **首页**：今日需要复习提醒、笔记快捷入口、创建笔记
- **复习**：复习中心（今日复习、困难词条、已掌握等）← 核心功能
- **笔记**：笔记列表，点击进入笔记详情和闪词学习
- **我的**：学习统计、设置、个人信息

### 3.8 各入口使用场景

| 入口 | 使用场景 | 主要功能 | 优先级 |
|------|---------|---------|--------|
| **首页快捷入口** | 每天打开app | 快速查看今日需要复习数量，一键进入复习 | 高 |
| **复习中心-今日复习** | 想复习该复习的词条 | 按复习时间展示需巩固词条（跨笔记） | 最高 |
| **复习中心-困难词条** | 想重点攻克难点 | 展示需改进和未掌握的词条 | 高 |
| **复习中心-已掌握** | 查看学习成果或长期复习 | 展示所有已掌握的词条 | 中 |
| **复习中心-按笔记分类** | 想选择某个笔记复习 | 按笔记分组展示词条和进度 | 中 |
| **笔记详情页** | 想学习某个笔记的词条 | 查看单个笔记的闪词列表和学习进度 | 高 |
| **学习统计** | 查看学习数据和进步 | 统计数据、趋势图、成就展示 | 中 |
| **搜索** | 想找某个具体词条 | 搜索并查看词条学习状态 | 低 |

### 3.9 数据查询逻辑

#### 查询今日复习词条（跨笔记）

```sql
SELECT 
  fc.id,
  fc.term,
  fc.status,
  n.title as note_title,
  rs.next_review_at,
  COUNT(lr.id) as attempt_count,
  MAX(lr.score) as best_score,
  MAX(lr.attempted_at) as last_studied_at
FROM flash_cards fc
JOIN notes n ON fc.note_id = n.id
JOIN review_schedule rs ON fc.id = rs.card_id
LEFT JOIN learning_records lr ON fc.id = lr.card_id
WHERE rs.next_review_at <= datetime('now')
  AND fc.status != 'mastered'
GROUP BY fc.id
ORDER BY rs.next_review_at ASC
LIMIT 50;
```

#### 查询困难词条（跨笔记）

```sql
SELECT 
  fc.id,
  fc.term,
  fc.status,
  n.title as note_title,
  COUNT(lr.id) as attempt_count,
  MAX(lr.score) as best_score,
  MAX(lr.attempted_at) as last_studied_at
FROM flash_cards fc
JOIN notes n ON fc.note_id = n.id
LEFT JOIN learning_records lr ON fc.id = lr.card_id
WHERE fc.status IN ('needsImprove', 'notMastered')
GROUP BY fc.id
ORDER BY best_score ASC, attempt_count DESC;
```

#### 查询已掌握词条（跨笔记）

```sql
SELECT 
  fc.id,
  fc.term,
  n.title as note_title,
  MAX(CASE WHEN lr.status = 'mastered' THEN lr.attempted_at END) as mastered_at,
  MAX(lr.score) as best_score
FROM flash_cards fc
JOIN notes n ON fc.note_id = n.id
LEFT JOIN learning_records lr ON fc.id = lr.card_id
WHERE fc.status = 'mastered'
GROUP BY fc.id
ORDER BY mastered_at DESC;
```

#### 按笔记分类统计

```sql
SELECT 
  n.id,
  n.title,
  COUNT(fc.id) as total_count,
  COUNT(CASE WHEN fc.status = 'mastered' THEN 1 END) as mastered_count,
  COUNT(CASE WHEN fc.status IN ('needsReview', 'needsImprove', 'notMastered') THEN 1 END) as review_count,
  COUNT(CASE WHEN fc.status = 'notStarted' THEN 1 END) as not_started_count
FROM notes n
LEFT JOIN flash_cards fc ON n.id = fc.note_id
WHERE n.is_deleted = 0
GROUP BY n.id
HAVING total_count > 0
ORDER BY review_count DESC, n.updated_at DESC;
```

### 3.10 用户引导流程

#### 新用户首次使用

```
第1天：创建笔记 → 生成闪词 → 学习词条 → 标记状态
    ↓
第2天：打开app → 首页提示"今日需要复习：X个" 
    ↓
点击"立即复习" → 进入复习中心 → 了解复习功能
    ↓
持续使用：复习中心成为主要入口
```

#### 核心使用路径

```
每日使用：
打开app → 首页看到今日需要复习数量 → 点击"立即复习"
    ↓
复习中心 → 今日复习 → 选择词条 → 开始学习
    ↓
学习完成 → 查看统计 → 获得成就感
```

#### 按需学习路径

```
想学习特定笔记：
笔记列表 → 选择笔记 → 笔记详情页 → 查看闪词进度 → 继续学习
```

```
想攻克难点：
复习中心 → 困难词条 → 查看需改进的词条 → 重点学习
```

```
想查看成果：
我的 → 学习统计 → 查看已掌握词条 → 学习趋势
```

### 3.11 产品优化建议

#### MVP阶段（最小可行产品）

必须实现的入口（优先级最高）：
1. **笔记详情页入口**：基础学习路径
2. **首页快捷入口**：今日需要复习提醒
3. **复习中心-今日复习**：核心复习功能

#### 第二阶段

扩展复习功能：
1. **复习中心-困难词条**：帮助攻克难点
2. **复习中心-按笔记分类**：按笔记维度复习
3. **学习统计-基础版**：查看学习数据

#### 第三阶段

完善体验：
1. **复习中心-已掌握词条**：成就感展示
2. **学习统计-完整版**：趋势图、详细分析
3. **搜索功能**：快速查找词条

---

## 4. 闪词与笔记的关联关系

### 3.1 数据模型

#### 笔记（Note）

```
Note {
  id: String              // 笔记ID
  title: String           // 笔记标题
  content: String         // 笔记内容
  createdAt: DateTime     // 创建时间
  updatedAt: DateTime     // 更新时间
  termCount: Int          // 关联的词条数量
}
```

#### 闪词卡片（FlashCard）

```
FlashCard {
  id: String              // 卡片ID
  term: String            // 词条内容
  noteId: String          // 所属笔记ID（外键）
  order: Int              // 在笔记中的顺序
  standardDefinition: String?  // 标准定义（可选）
  
  createdAt: DateTime     // 创建时间
  status: CardStatus      // 当前状态（见下方）
}
```

#### 卡片状态枚举（CardStatus）

```
enum CardStatus {
  notStarted,    // 未学习
  needsReview,   // 需巩固（良好）
  needsImprove,  // 需改进
  notMastered,   // 未掌握
  mastered       // 已掌握
}
```

#### 学习记录（LearningRecord）

```
LearningRecord {
  id: String              // 记录ID
  cardId: String          // 关联的卡片ID（外键）
  noteId: String          // 关联的笔记ID（冗余，便于查询）
  
  // 学习信息
  selectedRole: String    // 选择的角色（如"5岁孩子"）
  userExplanation: String // 用户的解释
  score: Int              // 评估分数（0-100）
  aiFeedback: String      // AI反馈内容
  status: CardStatus      // 本次评估的状态
  
  // 时间信息
  attemptedAt: DateTime   // 尝试时间
  attemptNumber: Int      // 第几次尝试（同一卡片）
}
```

### 3.2 关联关系图

```
Note (1) ←──→ (N) FlashCard (1) ←──→ (N) LearningRecord
   ↓                  ↓                      ↓
  笔记              闪词卡片               学习记录
```

关系说明：
- 一个笔记包含多个闪词卡片（1:N）
- 一个闪词卡片属于一个笔记（N:1）
- 一个闪词卡片有多个学习记录（1:N）
- 一个学习记录属于一个闪词卡片（N:1）

### 3.3 查询示例

#### 查询笔记的所有闪词（包含学习状态）

```sql
SELECT 
  fc.*,
  COUNT(lr.id) as attemptCount,
  MAX(lr.score) as bestScore,
  MAX(lr.attemptedAt) as lastStudiedAt
FROM FlashCard fc
LEFT JOIN LearningRecord lr ON fc.id = lr.cardId
WHERE fc.noteId = ?
GROUP BY fc.id
ORDER BY fc.order
```

#### 查询笔记的学习进度

```sql
SELECT 
  COUNT(CASE WHEN status = 'mastered' THEN 1 END) as masteredCount,
  COUNT(CASE WHEN status = 'needsReview' THEN 1 END) as reviewCount,
  COUNT(CASE WHEN status = 'needsImprove' THEN 1 END) as improveCount,
  COUNT(CASE WHEN status = 'notStarted' THEN 1 END) as notStartedCount,
  COUNT(*) as totalCount
FROM FlashCard
WHERE noteId = ?
```

### 3.4 级联操作

#### 删除笔记时

逻辑选择：
- **软删除**（推荐）：保留闪词卡片和学习记录，标记笔记为已删除
- **硬删除**：级联删除所有关联的闪词卡片和学习记录

推荐使用软删除，保留学习数据用于统计。

#### 重新生成闪词时

保留所有旧词条，新词条追加，自动去重：
1. AI提取新词条列表
2. 按词条内容（term）去重：
   - 已存在的词条：保持不变（保留学习状态和记录）
   - 新词条：插入数据库（status = 'notStarted'）
3. 所有学习记录保留

---

## 5. 闪词卡片的持久化

### 5.1 持久化策略

#### 本地存储（SQLite/Hive）

优点：
- 离线可用
- 快速读写
- 隐私保护

推荐使用 SQLite（通过 `sqflite` 包）。

#### 云端同步（可选）

优点：
- 跨设备同步
- 数据备份
- 多端协作

### 5.2 数据库表结构

#### 表1：notes（笔记表）

```sql
CREATE TABLE notes (
  id TEXT PRIMARY KEY,
  title TEXT NOT NULL,
  content TEXT NOT NULL,
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL,
  is_deleted INTEGER DEFAULT 0
);
```

#### 表2：flash_cards（闪词卡片表）

```sql
CREATE TABLE flash_cards (
  id TEXT PRIMARY KEY,
  term TEXT NOT NULL,
  note_id TEXT NOT NULL,
  order_index INTEGER NOT NULL,
  standard_definition TEXT,
  status TEXT NOT NULL DEFAULT 'notStarted',
  created_at INTEGER NOT NULL,
  
  FOREIGN KEY (note_id) REFERENCES notes(id),
  UNIQUE(note_id, term)  -- 同一笔记中词条唯一
);

-- 索引
CREATE INDEX idx_flash_cards_note_id ON flash_cards(note_id);
CREATE INDEX idx_flash_cards_status ON flash_cards(status);
```

#### 表3：learning_records（学习记录表）

```sql
CREATE TABLE learning_records (
  id TEXT PRIMARY KEY,
  card_id TEXT NOT NULL,
  note_id TEXT NOT NULL,
  selected_role TEXT NOT NULL,
  user_explanation TEXT NOT NULL,
  score INTEGER NOT NULL,
  ai_feedback TEXT NOT NULL,
  status TEXT NOT NULL,
  attempted_at INTEGER NOT NULL,
  attempt_number INTEGER NOT NULL,
  
  FOREIGN KEY (card_id) REFERENCES flash_cards(id),
  FOREIGN KEY (note_id) REFERENCES notes(id)
);

-- 索引
CREATE INDEX idx_learning_records_card_id ON learning_records(card_id);
CREATE INDEX idx_learning_records_note_id ON learning_records(note_id);
CREATE INDEX idx_learning_records_attempted_at ON learning_records(attempted_at);
```

#### 表4：review_schedule（复习计划表）

```sql
CREATE TABLE review_schedule (
  id TEXT PRIMARY KEY,
  card_id TEXT NOT NULL UNIQUE,
  next_review_at INTEGER NOT NULL,
  review_count INTEGER DEFAULT 0,
  
  FOREIGN KEY (card_id) REFERENCES flash_cards(id)
);

-- 索引
CREATE INDEX idx_review_schedule_next_review ON review_schedule(next_review_at);
```

### 5.3 数据生命周期

#### 创建闪词

```
用户生成闪词
    ↓
1. 保存到 flash_cards 表
   - status = 'notStarted'
   - is_removed = false
    ↓
2. 关联到笔记
   - note_id = 笔记ID
```

#### 学习闪词

```
用户提交解释
    ↓
1. AI评估返回分数和状态
    ↓
2. 保存到 learning_records 表
   - 记录解释、分数、反馈
    ↓
3. 更新 flash_cards 表
   - status = 评估结果状态
    ↓
4. 更新/创建 review_schedule 表
   - 计算 next_review_at
```

#### 复习调度

根据状态计算复习时间：

| 状态 | 复习间隔 | next_review_at 计算 |
|------|---------|---------------------|
| 良好（needsReview） | 1天 | 当前时间 + 24小时 |
| 需改进（needsImprove） | 3天 | 当前时间 + 72小时 |
| 未掌握（notMastered） | 当天 | 当前时间 + 4小时 |
| 已掌握（mastered） | 7天 | 当前时间 + 7天 |

#### 重新生成闪词

```
用户选择重新生成
    ↓
1. 调用AI提取新词条列表
    ↓
2. 遍历新词条列表：
   - 检查词条是否已存在（按 note_id + term 查询）
   - 如果已存在：跳过（保持原有状态）
   - 如果不存在：插入新词条
     INSERT INTO flash_cards
     (term, note_id, status = 'notStarted', ...)
    ↓
3. 旧词条保持不变
    ↓
4. 所有学习记录保留
```

### 5.4 数据查询优化

#### 查询需巩固的卡片

```sql
SELECT fc.*, rs.next_review_at
FROM flash_cards fc
INNER JOIN review_schedule rs ON fc.id = rs.card_id
WHERE fc.note_id = ?
  AND rs.next_review_at <= ?
ORDER BY rs.next_review_at ASC
```

#### 查询笔记学习统计

```sql
SELECT 
  fc.status,
  COUNT(*) as count
FROM flash_cards fc
WHERE fc.note_id = ?
GROUP BY fc.status
```

#### 查询卡片的学习历史

```sql
SELECT *
FROM learning_records
WHERE card_id = ?
ORDER BY attempted_at DESC
LIMIT 10
```

### 5.5 数据同步策略（可选）

如果需要云端同步：

#### 同步时机

- 学习记录保存后立即同步
- 应用启动时拉取最新数据
- 应用退出时推送本地数据
- 定时后台同步（如每5分钟）

#### 冲突处理

- 以最新时间戳为准（last-write-wins）
- 学习记录只增不改（append-only）
- 卡片状态取最新的

---

## 6. 核心产品流程总结

### 6.1 完整学习流程

```
1. 用户创建/查看笔记
    ↓
2. 点击"生成闪词卡片"（首次）或"继续学习"（再次）
    ↓
3. 查看学习进度概览
    ↓
4. 进入费曼学习页面
    ↓
5. 选择当前词条
    ↓
6. 选择解释角色（5岁孩子/教授等）
    ↓
7. 输入解释（文字/语音）
    ↓
8. AI评估打分（根据角色调整标准）
    ↓
9. 查看反馈和建议
    ↓
10. 根据评分选择操作：
    - 优秀：标记已掌握 → 下一张
    - 良好：查看标准答案/重新解释/下一张
    - 需改进：查看提示/重新解释
    - 未掌握：查看简化解释/类比/重新学习
    ↓
11. 保存学习记录
    ↓
12. 更新复习计划
    ↓
13. 继续下一个词条（循环5-12）
```

### 6.2 数据流转

```
笔记内容
    ↓
AI提取 → 闪词列表（保存到 flash_cards）
    ↓
用户学习 → 选择角色 → 输入解释
    ↓
AI评估 → 分数 + 反馈
    ↓
保存记录（learning_records）
    ↓
更新状态（flash_cards.status）
    ↓
设置复习（review_schedule.next_review_at）
```

---

## 7. 关键产品细节

### 7.1 角色系统的价值

1. **降低心理门槛**：选择简单角色（5岁孩子）让用户更敢于尝试
2. **提升学习深度**：选择高级角色（教授）促进深入思考
3. **个性化评估**：根据角色调整评估标准，更公平
4. **趣味性**：角色扮演增加学习乐趣

### 7.2 多轮对话的意义

1. **渐进式学习**：不一次性给答案，逐步引导
2. **记录成长**：每次尝试都记录，看到进步
3. **避免挫败感**：可以多次尝试，不会因一次失败就放弃

### 7.3 重新生成的智能处理

1. **保留学习成果**：所有旧词条的学习记录和状态不丢失
2. **适应内容变化**：笔记更新后可以重新提取，新词条自动添加
3. **自动去重**：按词条内容去重，已存在的词条保持不变

### 7.4 复习系统的科学性

1. **遗忘曲线**：根据掌握程度设置不同复习间隔
2. **优先级排序**：优先复习需巩固和需改进的词条
3. **长期记忆**：已掌握的词条也有长期复习计划

---

## 8. 技术实现要点

### 8.1 AI评估 Prompt 设计

```
系统提示词：
你是一位学习评估专家。用户选择以【{角色}】的身份解释词条【{词条}】。
请根据该角色的知识水平和表达方式，评估用户的解释是否准确、完整、清晰。

评分标准（0-100分）：
- 准确性（40%）：核心概念是否正确
- 完整性（30%）：是否覆盖关键要点
- 清晰度（20%）：表达是否清晰易懂
- 角色适配（10%）：是否符合角色的表达方式

输出格式（JSON）：
{
  "score": 85,
  "status": "needsReview",
  "correctPoints": ["...", "..."],
  "missingPoints": ["...", "..."],
  "suggestions": "...",
  "encouragement": "..."
}
```

### 8.2 状态管理

使用 GetX 的响应式状态管理：
- `currentCard`: 当前词条
- `learningProgress`: 学习进度
- `selectedRole`: 选择的角色
- `userExplanation`: 用户解释
- `evaluationResult`: 评估结果

### 8.3 数据缓存

- 内存缓存：当前笔记的闪词列表
- 本地缓存：SQLite数据库
- 云端缓存（可选）：服务器数据库

---

## 9. 未来扩展方向

1. **AI语音对话**：语音输入和语音反馈
2. **社交分享**：分享学习成果和优秀解释
3. **学习报告**：生成学习统计和分析报告
4. **协作学习**：多人共同学习同一笔记
5. **导出功能**：导出闪词卡片为Anki格式

---

**文档版本**：v1.0  
**最后更新**：2024年12月  
**适用产品**：费曼记忆法应用 - 闪词学习模块

